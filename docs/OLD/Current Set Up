 Deep Dive Analysis: Rebuild vs Refactor

  Executive Summary

  Recommendation: Strategic Refactoring, NOT Full Rebuild

  Your codebase has issues, but they're surgical problems in an otherwise solid foundation. A full rebuild would be expensive, risky, and throw away good architecture that's already working.

  ---
  What I Found vs. What You Suspected

  | Your Concern                                           | Reality                                                                |
  |--------------------------------------------------------|------------------------------------------------------------------------|
  | "bullmq/ and servicetitan-sync/ directories are empty" | FALSE - Both have 4-5 active workers                                   |
  | "46 route files with inconsistent naming"              | TRUE - But inconsistency is cosmetic, not structural                   |
  | "Multiple sync mechanisms fighting each other"         | PARTIALLY TRUE - They serve different purposes (see below)             |
  | "Script sprawl indicates core system issues"           | PARTIALLY TRUE - Some are one-off fixes, many are legitimate utilities |

  ---
  Architectural Strengths (Keep These)

  1. Well-Designed Sync Engine Pattern (services/api/src/sync/)
  sync/
  â”œâ”€â”€ pricebook/
  â”‚   â”œâ”€â”€ fetchers/      â† Clean separation
  â”‚   â”œâ”€â”€ comparators/   â† DDD-style
  â”‚   â”œâ”€â”€ appliers/      â† Each concern isolated
  â”‚   â””â”€â”€ pricebook-sync.engine.js  â† Clean orchestrator
  â””â”€â”€ scheduling/
      â””â”€â”€ (same pattern)
  This is actually excellent architecture - fetcher/comparator/applier is a proper sync engine pattern.

  2. Routes Index is Clean (routes/index.js:171 lines)
  - 30+ routes organized by domain
  - Clear section comments
  - No circular dependencies

  3. Database Schema is Solid (14 migrations, 7,209 lines)
  - Proper schema separation (raw.*, master.*, crm.*)
  - Migration files are numbered and organized

  4. Optional Engine Pattern (app.js:50-125)
  - Graceful degradation when components aren't available
  - Dynamic imports prevent startup failures

  ---
  Real Problems to Fix

  1. God File: pricebook-categories.js (2,199 lines)

  This file has:
  - Its own database pool management (lines 38-56)
  - Its own token management (lines 1456-1475)
  - In-memory error tracking (lines 261-285)
  - Inline recursive helpers (lines 506-533, 1926-1960)
  - 20+ route handlers

  Fix: Extract into service classes (2-3 day refactor)

  routes/pricebook-categories.js       â†’ 200 lines (just routing)
  services/pricebook/category.service.js
  services/pricebook/sync.service.js
  services/pricebook/error-tracker.js

  2. Naming Inconsistency

  health.js        AND  health.routes.js   â† Pick one
  crm.js           AND  crm.routes.js      â† Pick one

  Fix: 1-hour rename task, no logic changes

  3. Overlapping Sync Mechanisms

  | Mechanism                     | Purpose                                  | Conflict?    |
  |-------------------------------|------------------------------------------|--------------|
  | BullMQ Workers                | Background image downloads, notification | No           |
  | Temporal Workflows            | Full/incremental entity sync             | No           |
  | Sync Engine (fetcher/applier) | STâ†’PostgreSQL pricebook sync             | No           |
  | Direct scripts                | One-off data fixes                       | Some overlap |

  Reality: These aren't fighting - they handle different use cases. The only real cleanup needed is consolidating one-off scripts into the sync engine.

  4. Scripts That Should Be Routes/Workers

  backfill-missing.js          â†’ Should be a sync job
  debug-tech-sync.js           â†’ Should be a route endpoint
  gap-analysis.js              â†’ Should be a route endpoint

  Fix: Convert 5-6 scripts into API endpoints (~1-2 days)

  ---
  What a Rebuild Would Cost You

  | Component             | Lines of Code | Working? | Time to Rebuild |
  |-----------------------|---------------|----------|-----------------|
  | Sync Engine           | 2,500+        | Yes      | 2-3 weeks       |
  | 46 Route Files        | 11,326        | Yes      | 3-4 weeks       |
  | BullMQ Infrastructure | 1,500+        | Yes      | 1 week          |
  | Temporal Workflows    | 500+          | Yes      | 1 week          |
  | Database Schema       | 7,209         | Yes      | 2 weeks         |
  | Total                 | ~23,000       |          | 8-10 weeks      |

  ---
  Recommended Refactoring Plan

  Phase 1: Quick Wins (1-2 days)
  - Rename route files to consistent pattern (.routes.js)
  - Delete truly dead scripts (identify via git blame)
  - Add index files to empty directories or remove them

  Phase 2: God File Surgery (3-5 days)
  - Extract pricebook-categories.js into services
  - Move in-memory error tracker to Redis
  - Create shared pool management in db/

  Phase 3: Script Consolidation (2-3 days)
  - Convert utility scripts to API endpoints
  - Add admin UI for sync operations
  - Document which scripts are still needed

  Phase 4: Optional Cleanup (ongoing)
  - Reduce route file sizes (split files over 500 lines)
  - Add TypeScript gradually (start with new files)
  - Improve test coverage

  ---
  My Verdict

  Don't rebuild. You have:
  - A working sync engine with good separation of concerns
  - 372+ working API endpoints
  - Proper multi-schema database design
  - BullMQ + Temporal infrastructure that's already running

  What looks like chaos is actually organic growth with some deferred cleanup. The architecture decisions are sound - the execution just needs tidying.

  Total refactoring effort: 1-2 weeks for significant improvement
  Full rebuild effort: 8-10 weeks to get back to where you are now


  Current Database Architecture & Workflow Setup

  Database Schema Design

  Your database follows a multi-schema layered architecture that cleanly separates concerns:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           PostgreSQL Database (lazi)                        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   raw.*         â”‚   master.*      â”‚   crm.*         â”‚   public.*           â”‚
  â”‚   (Source of    â”‚   (Curated for  â”‚   (CRM-specific â”‚   (Core entities,    â”‚
  â”‚    Truth from   â”‚    Application  â”‚    overrides &  â”‚    workflows,        â”‚
  â”‚    ServiceTitan)â”‚    Use)         â”‚    customizationâ”‚    pricebook)        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  Schema Breakdown

  1. raw.* Schema - ServiceTitan Data Mirror

  Purpose: Exact copy of ServiceTitan API responses for querying without API rate limits

  | Table                       | Purpose                           | Key Fields                                        |
  |-----------------------------|-----------------------------------|---------------------------------------------------|
  | raw.st_customers            | Customer master data              | st_id, name, balance, full_data                   |
  | raw.st_locations            | Service locations with geocoding  | st_id, customer_id, lat/lng                       |
  | raw.st_jobs                 | Jobs with status tracking         | st_id, job_number, customer_id, status            |
  | raw.st_estimates            | Sales estimates                   | st_id, status, subtotal                           |
  | raw.st_invoices             | Invoice data                      | st_id, balance, customer, job                     |
  | raw.st_pricebook_categories | Pricebook categories from ST      | st_id, name, position, subcategories (JSONB)      |
  | raw.st_technicians          | Technician reference data         | st_id, name, team_id, zone_ids[]                  |
  | raw.sync_state              | Tracks last sync times per entity | table_name, last_full_sync, last_incremental_sync |

  2. master.* Schema - Application-Ready Data

  Purpose: Enriched, normalized data with CRM customizations and hierarchy support

  | Table                          | Purpose                                     | Key Fields                                        |
  |--------------------------------|---------------------------------------------|---------------------------------------------------|
  | master.pricebook_categories    | Hierarchical categories with CRM visibility | st_id, display_name, path (LTREE), is_visible_crm |
  | master.pricebook_subcategories | Flattened subcategories for fast access     | st_id, parent_st_id, depth, sort_order            |

  Special Features:
  - LTREE Extension for efficient hierarchy queries (path column)
  - Triggers for auto-updating subcategory_count, updated_at
  - CRM Override Support via display_name, is_visible_crm

  3. crm.* Schema - CRM Pipeline & Overrides

  Purpose: CRM-specific data, sync tracking, and local customizations

  | Table                   | Purpose                             | Key Fields                                                        |
  |-------------------------|-------------------------------------|-------------------------------------------------------------------|
  | crm.crm_contacts        | CRM contacts linked to ST customers | crm_id, st_customer_id, sync_status                               |
  | crm.pricebook_overrides | Local edits pending push to ST      | st_pricebook_id, override_name, override_image_data, pending_sync |
  | crm.crm_opportunities   | CRM pipeline opportunities          | st_id, stage, probability                                         |

  4. public.* Schema - Core Application Tables

  Purpose: Pricebook sync engine, workflow automation, chat sessions

  | Table                           | Purpose                                    |
  |---------------------------------|--------------------------------------------|
  | pricebook_categories            | Legacy pricebook with full sync metadata   |
  | pricebook_materials             | Materials with AI embeddings (vector 1536) |
  | pricebook_services              | Services with embeddings                   |
  | pricebook_equipment             | Equipment with embeddings                  |
  | pricebook_sync_log              | Audit log of all sync operations           |
  | pricebook_sync_conflicts        | Conflict tracking for resolution           |
  | pricebook_changes               | Complete audit trail (trigger-based)       |
  | pricebook_webhook_subscriptions | n8n webhook subscriptions                  |
  | chat_sessions                   | Conversational AI session storage          |
  | workflow_definitions            | Workflow automation templates              |
  | workflow_instances              | Active workflow executions                 |
  | workflow_step_executions        | Detailed step audit log                    |
  | scheduling_technicians          | Technicians for smart scheduling           |
  | scheduling_teams                | Teams for scheduling                       |
  | scheduling_zones                | Zone reference data                        |
  | scheduling_rules                | Scheduling business rules engine           |
  | scheduling_technician_skills    | Local intelligence (not in ST)             |

  ---
  Extensions Enabled

  | Extension | Purpose                                      |
  |-----------|----------------------------------------------|
  | uuid-ossp | UUID generation for primary keys             |
  | vector    | pgvector for AI embeddings (semantic search) |
  | pg_trgm   | Trigram search for fuzzy text matching       |
  | ltree     | Hierarchical path queries for categories     |

  ---
  Data Flow Architecture

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                         SERVICETITAN API                                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                  â”‚                  â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Temporal    â”‚  â”‚   BullMQ      â”‚  â”‚   Sync        â”‚
             â”‚   Workflows   â”‚  â”‚   Workers     â”‚  â”‚   Engine      â”‚
             â”‚ (Full/Incr.   â”‚  â”‚ (Images,      â”‚  â”‚ (Pricebook,   â”‚
             â”‚  Entity Sync) â”‚  â”‚  Notifications)â”‚  â”‚  Scheduling)  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                  â”‚                  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚         raw.* Schema                 â”‚
                     â”‚  (Source of Truth from ST)           â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â–¼                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   master.* Schema   â”‚   â”‚   crm.* Schema      â”‚
              â”‚  (App-Ready Data)   â”‚   â”‚  (CRM Overrides)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚         EXPRESS API ROUTES           â”‚
                     â”‚  (46 route files, 372+ endpoints)    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  Workflow & Sync Mechanisms

  1. Temporal Workflows (workers/temporal/)

  Purpose: Full & incremental entity sync with pause/resume/cancel support

  | Workflow                | Schedule      | Entities                             |
  |-------------------------|---------------|--------------------------------------|
  | fullSyncWorkflow        | On-demand     | customers, jobs, invoices, estimates |
  | incrementalSyncWorkflow | Every 4 hours | Same, but only modified records      |

  Features:
  - Pagination handling with continuation tokens
  - Rate limiting (200ms between pages)
  - Slack notifications on completion
  - Graceful pause/resume via signals

  2. Sync Engine Pattern (services/api/src/sync/)

  Purpose: Structured sync with change detection and conflict resolution

  sync/
  â”œâ”€â”€ pricebook/
  â”‚   â”œâ”€â”€ fetchers/
  â”‚   â”‚   â”œâ”€â”€ st-categories.fetcher.js
  â”‚   â”‚   â”œâ”€â”€ st-materials.fetcher.js
  â”‚   â”‚   â”œâ”€â”€ st-services.fetcher.js
  â”‚   â”‚   â””â”€â”€ st-equipment.fetcher.js
  â”‚   â”œâ”€â”€ comparators/
  â”‚   â”‚   â”œâ”€â”€ category.comparator.js
  â”‚   â”‚   â””â”€â”€ ... (detect changes)
  â”‚   â”œâ”€â”€ appliers/
  â”‚   â”‚   â”œâ”€â”€ category.applier.js
  â”‚   â”‚   â””â”€â”€ ... (apply CRUD)
  â”‚   â”œâ”€â”€ conflict-resolver.js
  â”‚   â”œâ”€â”€ pricebook-sync.engine.js    â† Main orchestrator
  â”‚   â””â”€â”€ sync-scheduler.js           â† Cron: 3AM full, 4hr incremental
  â”‚
  â””â”€â”€ scheduling/
      â”œâ”€â”€ fetchers/
      â”‚   â”œâ”€â”€ st-technicians.fetcher.js
      â”‚   â”œâ”€â”€ st-teams.fetcher.js
      â”‚   â”œâ”€â”€ st-zones.fetcher.js
      â”‚   â””â”€â”€ st-job-types.fetcher.js
      â”œâ”€â”€ comparators/
      â”œâ”€â”€ appliers/
      â””â”€â”€ scheduling-sync.engine.js   â† One-way sync (ST â†’ local)

  Sync Strategies:
  | Domain       | Direction       | Strategy                                                 |
  |--------------|-----------------|----------------------------------------------------------|
  | Pricebook    | Bidirectional   | Full change detection with conflict resolution           |
  | Scheduling   | ST â†’ Local only | Reference data only, real-time API for jobs/appointments |
  | CRM Contacts | Bidirectional   | Hash-based change detection                              |

  3. BullMQ Workers (services/api/src/workers/)

  Purpose: Background job processing with retries and monitoring

  | Worker                             | Queue          | Purpose                          |
  |------------------------------------|----------------|----------------------------------|
  | pricebook-image-download.worker.js | image-download | Async image download to DB       |
  | pricebook-category-sync.js         | category-sync  | Category tree rebuild            |
  | bullmq/inbound-sync.worker.js      | inbound-sync   | Inbound data processing          |
  | bullmq/outbound-sync.worker.js     | outbound-sync  | Push changes to external systems |
  | bullmq/notification.worker.js      | notifications  | Slack, email notifications       |

  ---
  Audit & Change Tracking

  Trigger-Based Audit (pricebook_changes table)

  -- Automatically tracks all INSERT/UPDATE/DELETE on pricebook tables
  CREATE TRIGGER trg_categories_audit
    AFTER INSERT OR UPDATE OR DELETE ON pricebook_categories
    FOR EACH ROW EXECUTE FUNCTION track_pricebook_change();

  Captured Data:
  - entity_type, entity_id, st_id
  - action (create/update/delete)
  - source (sync_from_st, api, chat, n8n, manual)
  - changed_fields, old_values, new_values
  - full_snapshot (complete state after change)

  Sync Conflict Resolution

  -- Conflicts stored in pricebook_sync_conflicts
  -- Status: unresolved, resolved_keep_st, resolved_keep_local, resolved_merged
  SELECT * FROM v_unresolved_conflicts ORDER BY created_at DESC;

  ---
  Real-Time Features

  Socket.io Events (Cache Invalidation)

  // Emitted on sync operations
  emitCategoriesSynced(tenantId, { count, type, incremental });
  emitCategoryUpdated(tenantId, { stId, name, changes });
  emitCategoriesPushed(tenantId, { count, success, failed });
  emitSyncStarted(tenantId, entity);
  emitSyncCompleted(tenantId, { entity, fetched, duration });
  emitSyncFailed(tenantId, { entity, error });

  pg_notify for Cache Invalidation

  // Used in pricebook-category-sync.js for invalidating in-memory caches
  await pool.query("SELECT pg_notify('cache_invalidation', $1)", [JSON.stringify({ table, key })]);

  ---
  Key Database Views

  | View                   | Purpose                                    |
  |------------------------|--------------------------------------------|
  | v_active_materials     | Active materials with category info joined |
  | v_active_services      | Active services with category info joined  |
  | v_active_equipment     | Active equipment with category info joined |
  | v_unresolved_conflicts | Conflicts pending resolution               |
  | v_recent_syncs         | Last 100 sync operations                   |

  ---
  Utility Functions

  | Function                                                | Purpose                                 |
  |---------------------------------------------------------|-----------------------------------------|
  | get_sync_stats()                                        | Returns sync statistics per entity type |
  | search_materials_by_embedding(vector, threshold, limit) | Semantic search using pgvector          |
  | get_category_tree(tenant_id, type, include_inactive)    | Returns hierarchical tree structure     |
  | toggle_category_visibility(st_id, visible, cascade)     | Bulk visibility toggle                  |
  | find_technicians_by_skills(skills[], zone_id)           | Skill-based technician matching         |
  | get_technician_with_skills(st_id)                       | Technician with skills JSONB            |
  | get_scheduling_stats()                                  | Scheduling entity counts                |

  ---
  Migration Summary

  | Migration                           | Lines | Purpose                                                |
  |-------------------------------------|-------|--------------------------------------------------------|
  | 001_raw_schema.sql                  | 972   | Pricebook sync engine tables with AI embeddings        |
  | 002_servicetitan_complete.sql       | ~500  | st_customers, st_locations, st_jobs, st_business_units |
  | 003_workflow_engine.sql             | ~300  | Workflow definitions, instances, step executions       |
  | 009_scheduling_schema.sql           | ~400  | Scheduling tables, technician skills, rules engine     |
  | 011_crm_sync.sql                    | ~200  | CRM contacts, pipeline sync                            |
  | 020_master_pricebook_categories.sql | 870   | Master category hierarchy with LTREE                   |

  Total: ~7,200 lines of carefully structured SQL

  ---
  This architecture represents a solid foundation with proper separation of concerns. The main issues are in the application layer (god files, naming inconsistency), not in the database design.



  Your migration to Supabase is partially complete. The core database connectivity works (Supabase provides PostgreSQL), but there are several broken references, conflicting configurations, and orphaned code that need cleanup.

  ---
  Current State

  | Component             | Status         | Notes                                  |
  |-----------------------|----------------|----------------------------------------|
  | Database Connection   | âœ… Working     | Using Supabase PostgreSQL via pooler   |
  | Prisma Client         | âœ… Working     | Uses DATABASE_URL from env             |
  | pg Pool (raw SQL)     | âœ… Working     | Auto-detects Supabase for SSL          |
  | Supabase Storage      | âš ï¸ Partial     | Configured but not universally used    |
  | S3 Client             | âŒ Orphaned    | Still exists, likely unused            |
  | Local Docker Postgres | âŒ Conflicting | docker-compose.yml still defines it    |
  | Grafana Datasource    | âŒ Broken      | Points to old pc-postgres:5432         |
  | Hardcoded Fallbacks   | âŒ Broken      | 8+ files have localhost:5432 fallbacks |

  ---
  Broken References Found

  1. Docker Compose - Local PostgreSQL Container Still Defined

  File: docker-compose.yml (lines 5-20)
  # THIS SHOULD BE REMOVED - You're using Supabase now
  postgres:
    container_name: lazi-postgres
    image: postgres:16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      ...

  Also: docker-compose.yml line 127:
  DATABASE_URL=postgresql://.../postgres:5432/${POSTGRES_DB:-lazi}

  Impact: Local development still tries to use Docker PostgreSQL instead of Supabase.

  ---
  2. Grafana Datasource - Points to Nonexistent Container

  File: config/grafana/provisioning/datasources/datasources.yml
  - name: PostgreSQL
    type: postgres
    url: pc-postgres:5432          # â† BROKEN - This container doesn't exist
    database: perfectcatch         # â† WRONG DATABASE NAME
    user: postgres

  Fix needed: Update to Supabase connection or remove PostgreSQL datasource.

  ---
  3. Hardcoded PostgreSQL Fallbacks in Source Code

  These files have fallback connection strings that would fail if DATABASE_URL is not set:

  | File                                                | Line | Fallback Value                                                     |
  |-----------------------------------------------------|------|--------------------------------------------------------------------|
  | services/api/src/routes/pricebook-categories.js     | 42   | postgresql://localhost:5432/lazi                                   |
  | services/api/src/routes/pricebook-services.js       | 16   | postgresql://postgres:perfectcatch2025@localhost:5432/perfectcatch |
  | services/api/src/routes/admin.js                    | 182  | postgresql://postgres:perfectcatch2025@localhost:5432/perfectcatch |
  | services/api/src/routes/system.routes.js            | 24   | postgresql://postgres:perfectcatch2025@localhost:5432/perfectcatch |
  | services/api/src/workers/pricebook-category-sync.js | 124  | postgresql://localhost:5432/lazi                                   |
  | apps/api/src/routes/pricebook-categories.ts         | 16   | postgresql://localhost:5432/lazi                                   |

  Risk: If DATABASE_URL env var is missing, app connects to nonexistent local PostgreSQL.

  ---
  4. Infrastructure Docker Compose - Old "perfectcatch" References

  File: infrastructure/docker/docker-compose.yml
  SERVICETITAN_DATABASE_URL=postgresql://postgres:Catchadmin%402025@postgres:5432/perfectcatch_automation
  This references an old database name and local container.

  ---
  5. Orphaned S3 Client Code

  File: services/api/src/services/s3Client.js (170 lines)

  This file is fully functional but appears unused since you switched to Supabase Storage. It's imported in config but never actually called if AWS credentials aren't set.

  Files that import it:
  - services/api/src/config/index.js (defines AWS config but likely not used)
  - services/api/src/config/env.schema.js (optional AWS variables)

  ---
  6. Storage Architecture Confusion

  You have two storage systems configured:

  | System           | Config File                           | Usage                            |
  |------------------|---------------------------------------|----------------------------------|
  | Supabase Storage | services/api/src/services/storage.js  | âœ… Used for pricebook images     |
  | AWS S3           | services/api/src/services/s3Client.js | âŒ Orphaned, credentials not set |

  The image download worker stores images directly in PostgreSQL (image_data BYTEA column), not in either storage system:
  // pricebook-image-download.worker.js:99
  // Stores to raw.st_pricebook_categories.image_data column

  ---
  7. Old "perfectcatch" Database Name References

  Several files reference the old database name perfectcatch or perfectcatch_automation:

  | Location                                      | Old Reference           |
  |-----------------------------------------------|-------------------------|
  | services/api/src/routes/pricebook-services.js | perfectcatch            |
  | services/api/src/routes/admin.js              | perfectcatch            |
  | services/api/src/routes/system.routes.js      | perfectcatch            |
  | infrastructure/docker/docker-compose.yml      | perfectcatch_automation |
  | config/grafana/.../datasources.yml            | perfectcatch            |
  | services/api/scripts/local-setup.sh           | perfectcatch_automation |

  Your Supabase database is named postgres (standard Supabase default).

  ---
  8. Conflicting .env Files

  You have multiple .env files with different configurations:

  | File              | DATABASE_URL                                                                                              |
  |-------------------|-----------------------------------------------------------------------------------------------------------|
  | .env.production   | postgresql://postgres:...@db.cvqduvqzkvqnjouuzldk.supabase.co:5432/postgres (Direct)                      |
  | services/api/.env | postgresql://postgres.cvqduvqzkvqnjouuzldk:...@aws-1-us-east-2.pooler.supabase.com:5432/postgres (Pooler) |

  Note: Both work, but using different connection modes. Production uses direct connection; local uses pooler.

  ---
  What's Actually Working

  Despite the mess, the core flows work:

  âœ… App â†’ DATABASE_URL env var â†’ Supabase PostgreSQL (pooler)
  âœ… Prisma â†’ DATABASE_URL â†’ Supabase PostgreSQL
  âœ… Storage service â†’ SUPABASE_URL/KEY â†’ Supabase Storage bucket
  âœ… Image downloads â†’ Store directly in PostgreSQL BYTEA columns

  ---
  Recommended Cleanup Actions

  Priority 1: Remove Broken/Conflicting Config

  | Action                            | Files to Modify                          |
  |-----------------------------------|------------------------------------------|
  | Remove local postgres service     | docker-compose.yml lines 5-20            |
  | Remove/update Grafana datasource  | config/grafana/.../datasources.yml       |
  | Remove old infrastructure compose | infrastructure/docker/docker-compose.yml |

  Priority 2: Fix Hardcoded Fallbacks

  Replace all hardcoded PostgreSQL fallbacks with proper error handling:

  // BEFORE (broken)
  const connectionString = process.env.DATABASE_URL || 'postgresql://localhost:5432/lazi';

  // AFTER (correct)
  const connectionString = process.env.DATABASE_URL;
  if (!connectionString) {
    throw new Error('DATABASE_URL environment variable is required');
  }

  Files to fix:
  - services/api/src/routes/pricebook-categories.js
  - services/api/src/routes/pricebook-services.js
  - services/api/src/routes/admin.js
  - services/api/src/routes/system.routes.js
  - services/api/src/workers/pricebook-category-sync.js

  Priority 3: Remove Orphaned Code

  | File                                  | Action                     |
  |---------------------------------------|----------------------------|
  | services/api/src/services/s3Client.js | Delete if not using AWS S3 |
  | services/api/scripts/local-setup.sh   | Update or delete           |
  | docs-backup/migrate-to-lazi.sh        | Delete (obsolete)          |

  Priority 4: Consolidate .env Files

  Create a single source of truth:
  - Production: Use .env.production with direct Supabase connection
  - Development: Create .env.development with pooler connection
  - Remove conflicting services/api/.env or sync it

  ---
  Storage Architecture Decision Needed

  You currently have 3 image storage strategies:

  1. Supabase Storage (storage.js) - External bucket storage
  2. AWS S3 (s3Client.js) - Orphaned, not configured
  3. PostgreSQL BYTEA (image_data column) - Currently used by image worker

  Recommendation: Pick one and remove the others. PostgreSQL BYTEA is fine for small images but may cause database bloat at scale. Supabase Storage is already configured and would be cleaner.

  ---
  Summary Table

  | Issue                           | Severity | Effort to Fix   |
  |---------------------------------|----------|-----------------|
  | Docker PostgreSQL still defined | Medium   | 5 min           |
  | Grafana datasource broken       | Low      | 5 min           |
  | 6 hardcoded localhost fallbacks | High     | 30 min          |
  | S3 client orphaned              | Low      | 5 min           |
  | Old database name references    | Medium   | 15 min          |
  | Multiple .env file confusion    | Medium   | 15 min          |
  | Storage architecture unclear    | Medium   | Decision needed |



    Comprehensive System Audit: Broken Services, Issues & Current Setup

  Critical Issues Found

  ğŸ”´ CRITICAL: Database is Nearly Empty

  | Table                       | Expected Records  | Actual Records |
  |-----------------------------|-------------------|----------------|
  | raw.st_customers            | 1,705 (from logs) | 0              |
  | raw.st_jobs                 | ~2,500+           | 0              |
  | raw.st_estimates            | 1,789 (from logs) | 0              |
  | raw.st_technicians          | 9                 | 0              |
  | public.raw_sync_state       | 17+ entries       | 0              |
  | master.pricebook_categories | N/A               | 12 âœ…          |

  Root Cause: The sync fetches data successfully from ServiceTitan (logs show "Completed fetch for raw.st_customers: 1705 records") but then fails to persist with "Full sync failed" errors. The upsert operations are failing silently.

  ---
  ğŸ”´ CRITICAL: CRM Sync Completely Broken

  Error from logs:
  relation "crm.crm_sync_log" does not exist

  Missing Tables in crm Schema:

  | Expected Table         | Status                                   |
  |------------------------|------------------------------------------|
  | crm.crm_sync_log       | âŒ Missing                               |
  | crm.crm_contacts       | âŒ Missing (exists as crm.contacts)      |
  | crm.crm_opportunities  | âŒ Missing (exists as crm.opportunities) |
  | crm.crm_webhook_events | âŒ Missing                               |
  | crm.v_sync_status      | âŒ Missing (view)                        |
  | crm.v_recent_activity  | âŒ Missing (view)                        |

  Actual CRM Tables:
  - crm.contacts (naming mismatch - code expects crm.crm_contacts)
  - crm.opportunities
  - crm.activities
  - crm.pipelines
  - crm.pipeline_stages
  - crm.pricebook_overrides

  ---
  ğŸŸ  HIGH: Workflow Engine Schema Mismatch

  Code expects: workflow.definitions
  Actual tables:
  - workflow.definitions âœ…
  - workflow.executions âœ…
  - workflow.templates
  - workflow.stage_actions
  - workflow.merge_rules
  - workflow.messaging_templates

  But public.workflow_definitions and public.workflow_instances also exist (duplicates in wrong schema).

  Records: 0 workflow definitions, 0 instances

  ---
  ğŸŸ  HIGH: Frontend Cache Permission Error

  Error: EACCES: permission denied, mkdir '/app/.next/cache'

  The Next.js container cannot write to its cache directory, causing repeated errors for image routes.

  ---
  ğŸŸ¡ MEDIUM: Duplicate Tables Across Schemas

  | Data        | Locations                                                                                |
  |-------------|------------------------------------------------------------------------------------------|
  | Customers   | raw.st_customers, public.st_customers, public.raw_st_customers                           |
  | Jobs        | raw.st_jobs, public.st_jobs, public.raw_st_jobs                                          |
  | Technicians | raw.st_technicians, public.st_technicians, public.raw_st_technicians, master.technicians |

  This creates confusion about which table is the source of truth.

  ---
  Current Docker Services Status

  | Container                   | Status     | Purpose             | Issues                  |
  |-----------------------------|------------|---------------------|-------------------------|
  | lazi-api                    | âœ… Healthy | Main API            | Sync failures           |
  | lazi-web                    | âœ… Up      | Next.js Frontend    | Cache permission errors |
  | lazi-redis                  | âœ… Healthy | Cache/Queue         | OK                      |
  | perfect-catch-st-automation | âœ… Healthy | Legacy ST sync?     | Duplicate of lazi-api?  |
  | st-sync-worker              | âœ… Healthy | Sync worker         | OK                      |
  | st-workflow-worker          | âœ… Healthy | Workflow worker     | No workflows defined    |
  | st-monitoring-agent         | âœ… Healthy | Monitoring          | OK                      |
  | payload-cms                 | âœ… Up      | CRM Backend         | OK                      |
  | n8n                         | âœ… Up      | Workflow automation | OK                      |

  Potentially Redundant Services:
  - perfect-catch-st-automation appears to duplicate lazi-api
  - Both run on port 3001 (one on host, one internal)

  ---
  CRM Pipeline Configuration

  File: services/api/src/config/crm-pipelines.js

  | Pipeline         | Slug             | Stages                                                                                |
  |------------------|------------------|---------------------------------------------------------------------------------------|
  | Sales Pipeline   | sales-pipeline   | Contacted â†’ Appointment Scheduled â†’ Proposal Sent â†’ Negotiation â†’ Job Sold â†’ Job Lost |
  | Install Pipeline | install-pipeline | Install Scheduled â†’ In Progress â†’ Inspection â†’ Completed â†’ Warranty                   |

  Business Unit â†’ Pipeline Mapping:
  - Pool/Electrical Sales & Service â†’ Sales Pipeline
  - Pool/Electrical Install â†’ Install Pipeline

  Integration: Syncs with Payload CMS at http://localhost:3005/api

  ---
  Frontend Directory Structure

  apps/web/
  â”œâ”€â”€ app/
  â”‚   â”œâ”€â”€ (auth)/
  â”‚   â”‚   â””â”€â”€ login/page.tsx              # Login page
  â”‚   â”œâ”€â”€ (dashboard)/
  â”‚   â”‚   â”œâ”€â”€ layout.tsx                  # Dashboard layout (auth DISABLED for testing)
  â”‚   â”‚   â”œâ”€â”€ dashboard/page.tsx          # Main dashboard
  â”‚   â”‚   â”œâ”€â”€ pricebook/page.tsx          # Pricebook browser
  â”‚   â”‚   â”œâ”€â”€ pipeline/
  â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx                # Pipeline kanban view
  â”‚   â”‚   â”‚   â””â”€â”€ [id]/page.tsx           # Single pipeline detail
  â”‚   â”‚   â”œâ”€â”€ contacts/
  â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx                # Contacts list
  â”‚   â”‚   â”‚   â””â”€â”€ [id]/page.tsx           # Contact detail
  â”‚   â”‚   â”œâ”€â”€ inbox/page.tsx              # Unified inbox
  â”‚   â”‚   â”œâ”€â”€ automations/page.tsx        # Workflow automations
  â”‚   â”‚   â”œâ”€â”€ tasks/page.tsx              # Task management
  â”‚   â”‚   â”œâ”€â”€ inventory/
  â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx                # Inventory list
  â”‚   â”‚   â”‚   â””â”€â”€ warehouse/[id]/page.tsx # Warehouse detail
  â”‚   â”‚   â”œâ”€â”€ purchasing/vendors/page.tsx # Vendors
  â”‚   â”‚   â”œâ”€â”€ settings/page.tsx           # Settings
  â”‚   â”‚   â””â”€â”€ developer/page.tsx          # Developer dashboard
  â”‚   â”œâ”€â”€ api/                            # Next.js API routes (28 files)
  â”‚   â”‚   â”œâ”€â”€ auth/[...nextauth]/route.ts
  â”‚   â”‚   â”œâ”€â”€ pricebook/...
  â”‚   â”‚   â”œâ”€â”€ contacts/...
  â”‚   â”‚   â””â”€â”€ ...
  â”‚   â”œâ”€â”€ layout.tsx                      # Root layout
  â”‚   â””â”€â”€ page.tsx                        # Home (redirects)
  â”‚
  â”œâ”€â”€ components/
  â”‚   â”œâ”€â”€ layout/
  â”‚   â”‚   â”œâ”€â”€ sidebar.tsx                 # Main navigation (28 nav items)
  â”‚   â”‚   â””â”€â”€ header.tsx                  # Top header
  â”‚   â”œâ”€â”€ dashboard/                      # Dashboard widgets
  â”‚   â”œâ”€â”€ pricebook/                      # Pricebook components
  â”‚   â”œâ”€â”€ pipeline/                       # Kanban components
  â”‚   â”œâ”€â”€ contacts/                       # Contact components
  â”‚   â”œâ”€â”€ inbox/                          # Inbox components
  â”‚   â”œâ”€â”€ developer/                      # Dev tools
  â”‚   â”œâ”€â”€ builder/                        # Page builder
  â”‚   â”œâ”€â”€ shared/                         # Shared components
  â”‚   â””â”€â”€ ui/                             # shadcn/ui components
  â”‚
  â”œâ”€â”€ stores/
  â”‚   â”œâ”€â”€ auth-store.ts                   # Auth state (Zustand)
  â”‚   â””â”€â”€ ui-store.ts                     # UI state
  â”‚
  â”œâ”€â”€ hooks/                              # Custom React hooks
  â”œâ”€â”€ lib/                                # Utilities
  â”œâ”€â”€ providers/                          # Context providers
  â””â”€â”€ types/                              # TypeScript types

  Sidebar Navigation Items:
  1. Dashboard
  2. Calls (Inbound/Outbound)
  3. Schedule
  4. Dispatch
  5. Pipeline
  6. Contacts
  7. Communication (Inbox/Email/SMS/Calls)
  8. Accounting (Invoices/Payments/Reports)
  9. Purchasing (Orders/Vendors)
  10. Inventory
  11. Follow Up
  12. Reports
  13. Marketing (Campaigns/Leads)
  14. Automations
  15. Fleet Pro
  16. Pricebook (Services/Materials/Equipment/Categories)
  17. Task Manager
  18. Settings
  19. Developer

  ---
  Backend Directory Structure

  services/api/
  â”œâ”€â”€ src/
  â”‚   â”œâ”€â”€ app.js                          # Express app setup
  â”‚   â”œâ”€â”€ server.js                       # Server entry point
  â”‚   â”‚
  â”‚   â”œâ”€â”€ routes/                         # 46 route files
  â”‚   â”‚   â”œâ”€â”€ auth.routes.js              # Authentication
  â”‚   â”‚   â”œâ”€â”€ crm.routes.js               # CRM endpoints
  â”‚   â”‚   â”œâ”€â”€ pricebook-categories.js     # 2,199 lines (GOD FILE)
  â”‚   â”‚   â”œâ”€â”€ scheduling.routes.js        # 944 lines
  â”‚   â”‚   â”œâ”€â”€ workflow.js                 # Workflow management
  â”‚   â”‚   â”œâ”€â”€ image-queue.routes.js       # Image queue API
  â”‚   â”‚   â”œâ”€â”€ system.routes.js            # Developer dashboard
  â”‚   â”‚   â””â”€â”€ ... (42 more)
  â”‚   â”‚
  â”‚   â”œâ”€â”€ sync/                           # Sync engines
  â”‚   â”‚   â”œâ”€â”€ pricebook/
  â”‚   â”‚   â”‚   â”œâ”€â”€ fetchers/               # ST API fetchers
  â”‚   â”‚   â”‚   â”œâ”€â”€ comparators/            # Change detection
  â”‚   â”‚   â”‚   â”œâ”€â”€ appliers/               # CRUD operations
  â”‚   â”‚   â”‚   â””â”€â”€ pricebook-sync.engine.js
  â”‚   â”‚   â”œâ”€â”€ scheduling/
  â”‚   â”‚   â”‚   â””â”€â”€ scheduling-sync.engine.js
  â”‚   â”‚   â””â”€â”€ crm/
  â”‚   â”‚       â””â”€â”€ crm-sync.worker.js      # CRM sync (BROKEN)
  â”‚   â”‚
  â”‚   â”œâ”€â”€ workers/
  â”‚   â”‚   â”œâ”€â”€ pricebook-category-sync.js
  â”‚   â”‚   â”œâ”€â”€ pricebook-image-download.worker.js
  â”‚   â”‚   â”œâ”€â”€ start-image-worker.js
  â”‚   â”‚   â””â”€â”€ bullmq/                     # BullMQ workers
  â”‚   â”‚       â”œâ”€â”€ inbound-sync.worker.js
  â”‚   â”‚       â”œâ”€â”€ outbound-sync.worker.js
  â”‚   â”‚       â””â”€â”€ notification.worker.js
  â”‚   â”‚
  â”‚   â”œâ”€â”€ services/
  â”‚   â”‚   â”œâ”€â”€ stClient.js                 # ServiceTitan API client
  â”‚   â”‚   â”œâ”€â”€ tokenManager.js             # OAuth token management
  â”‚   â”‚   â”œâ”€â”€ storage.js                  # Supabase Storage
  â”‚   â”‚   â”œâ”€â”€ s3Client.js                 # AWS S3 (ORPHANED)
  â”‚   â”‚   â”œâ”€â”€ database.js                 # PostgreSQL pool
  â”‚   â”‚   â”œâ”€â”€ workflow/                   # Workflow engine
  â”‚   â”‚   â”œâ”€â”€ cache/                      # Cache services
  â”‚   â”‚   â”œâ”€â”€ sync/                       # Sync orchestrator
  â”‚   â”‚   â””â”€â”€ monitoring/                 # Health monitoring
  â”‚   â”‚
  â”‚   â”œâ”€â”€ integrations/
  â”‚   â”‚   â”œâ”€â”€ crm/
  â”‚   â”‚   â”‚   â””â”€â”€ crm-api-client.js       # Payload CMS client
  â”‚   â”‚   â”œâ”€â”€ salesforce/                 # Salesforce integration
  â”‚   â”‚   â””â”€â”€ slack/                      # Slack integration
  â”‚   â”‚
  â”‚   â”œâ”€â”€ queues/
  â”‚   â”‚   â”œâ”€â”€ connection.js               # Redis connection
  â”‚   â”‚   â”œâ”€â”€ image-download.queue.js     # Image queue
  â”‚   â”‚   â””â”€â”€ schedulers.js               # Queue schedulers
  â”‚   â”‚
  â”‚   â”œâ”€â”€ db/
  â”‚   â”‚   â”œâ”€â”€ prisma.js                   # Prisma client
  â”‚   â”‚   â”œâ”€â”€ redis.js                    # Redis client
  â”‚   â”‚   â””â”€â”€ schema-connection.js        # Schema-aware pool
  â”‚   â”‚
  â”‚   â”œâ”€â”€ middleware/
  â”‚   â”‚   â”œâ”€â”€ auth.middleware.js
  â”‚   â”‚   â”œâ”€â”€ errorHandler.js
  â”‚   â”‚   â”œâ”€â”€ rate-limit.js
  â”‚   â”‚   â””â”€â”€ requestLogger.js
  â”‚   â”‚
  â”‚   â””â”€â”€ config/
  â”‚       â”œâ”€â”€ index.js                    # Main config
  â”‚       â”œâ”€â”€ crm-pipelines.js            # CRM pipeline config
  â”‚       â””â”€â”€ env.schema.js               # Env validation
  â”‚
  â”œâ”€â”€ scripts/                            # 34 utility scripts
  â”œâ”€â”€ prisma/                             # Prisma schema
  â””â”€â”€ tests/                              # Test files

  ---
  Data Flow Architecture (Current State)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    SERVICETITAN API                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ OAuth Token
                                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    lazi-api Container                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚ Sync Workers    â”‚  â”‚ BullMQ Workers  â”‚  â”‚ Express Routes  â”‚ â”‚
  â”‚  â”‚ (Fetch Data)    â”‚  â”‚ (Background)    â”‚  â”‚ (46 files)      â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚           â”‚ âŒ FAILING         â”‚                    â”‚          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼                    â–¼                    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    Supabase PostgreSQL                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
  â”‚  â”‚ raw.*       â”‚  â”‚ master.*    â”‚  â”‚ crm.*       â”‚             â”‚
  â”‚  â”‚ (EMPTY!)    â”‚  â”‚ (12 cats)   â”‚  â”‚ (SCHEMA     â”‚             â”‚
  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚  MISMATCH)  â”‚             â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    Payload CMS (port 3333)                      â”‚
  â”‚  â€¢ Contacts                                                     â”‚
  â”‚  â€¢ Opportunities                                                â”‚
  â”‚  â€¢ Pipeline stages                                              â”‚
  â”‚  (CRM sync BROKEN - missing tables)                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    lazi-web Container (Next.js)                 â”‚
  â”‚  â€¢ Dashboard pages                                              â”‚
  â”‚  â€¢ Pricebook browser âœ… (works - has 12 categories)            â”‚
  â”‚  â€¢ Pipeline view (empty - no data)                              â”‚
  â”‚  â€¢ Contacts (empty - no data)                                   â”‚
  â”‚  (AUTH DISABLED for testing)                                    â”‚
  â”‚  (CACHE PERMISSION ERROR)                                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  Summary of Issues to Fix

  | Priority | Issue                            | Impact             | Fix Effort |
  |----------|----------------------------------|--------------------|------------|
  | ğŸ”´ P0    | Sync not persisting data         | No data in system  | 2-4 hours  |
  | ğŸ”´ P0    | CRM schema mismatch              | CRM sync broken    | 1 hour     |
  | ğŸ”´ P0    | Missing crm.crm_sync_log table   | CRM errors         | 30 min     |
  | ğŸŸ  P1    | Duplicate tables across schemas  | Confusion          | 2 hours    |
  | ğŸŸ  P1    | Frontend cache permissions       | Image errors       | 30 min     |
  | ğŸŸ¡ P2    | Auth disabled in frontend        | Security risk      | 5 min      |
  | ğŸŸ¡ P2    | Orphaned S3 client code          | Dead code          | 10 min     |
  | ğŸŸ¡ P2    | pricebook-categories.js god file | Maintainability    | 1-2 days   |
  | ğŸŸ¡ P3    | Hardcoded localhost fallbacks    | Potential failures | 30 min     |

  ---
  Immediate Action Items

  1. Fix the sync persistence issue - Data is being fetched but not saved
  2. Run the CRM migration - Create missing tables (crm.crm_sync_log, etc.) or rename existing ones
  3. Fix Docker cache permissions - chmod or volume mount fix
  4. Re-enable authentication - Uncomment auth check in layout.tsx
  5. Consolidate duplicate tables - Pick one schema as source of truth
